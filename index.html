<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pakistan Stock Tax Calculator - FIFO Capital Gains Tax</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Pakistan Stock Exchange</h1>
            <h2>FIFO Tax Calculator</h2>
            <p class="subtitle">Capital Gains Tax Calculator with T+2 Settlement</p>
        </header>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="setting-item">
                <label class="toggle-label">
                    <input type="checkbox" id="filerStatus" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Filer Status</span>
                </label>
                <span class="setting-description" id="filerStatusText">Current: Filer (15% flat rate)</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Transaction Input -->
            <section class="card">
                <h3>Add Transaction</h3>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionType">Type</label>
                            <select id="transactionType" required>
                                <option value="BUY">Buy</option>
                                <option value="SELL">Sell</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="symbol">Symbol</label>
                            <input type="text" id="symbol" placeholder="e.g., OGDC" required>
                        </div>

                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" min="1" placeholder="100" required>
                        </div>

                        <div class="form-group">
                            <label for="price">Price (PKR)</label>
                            <input type="number" id="price" min="0" step="0.01" placeholder="100.00" required>
                        </div>

                        <div class="form-group">
                            <label for="tradeDate">Trade Date</label>
                            <input type="date" id="tradeDate" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </form>
            </section>

            <!-- Holdings Display -->
            <section class="card">
                <div class="section-header">
                    <h3>Current Holdings</h3>
                    <button class="btn btn-secondary" onclick="app.refreshHoldings()">Refresh</button>
                </div>
                <div id="holdingsDisplay" class="holdings-display">
                    <p class="empty-state">No holdings yet. Add buy transactions to get started.</p>
                </div>
            </section>

            <!-- Realized Gains -->
            <section class="card">
                <div class="section-header">
                    <h3>Realized Gains & Tax</h3>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="app.exportToPDF()">Export PDF</button>
                        <button class="btn btn-secondary" onclick="app.exportToJSON()">Export JSON</button>
                    </div>
                </div>
                <div id="realizedGainsDisplay" class="realized-gains-display">
                    <p class="empty-state">No sales recorded yet.</p>
                </div>
            </section>

            <!-- Tax Summary -->
            <section class="card tax-summary">
                <h3>Tax Summary</h3>
                <div id="taxSummaryDisplay" class="tax-summary-display">
                    <div class="summary-item">
                        <span class="summary-label">Total Gains:</span>
                        <span class="summary-value" id="totalGains">Rs. 0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Losses:</span>
                        <span class="summary-value" id="totalLosses">Rs. 0.00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Net Gain:</span>
                        <span class="summary-value" id="netGain">Rs. 0.00</span>
                    </div>
                    <div class="summary-item highlight">
                        <span class="summary-label">Tax Liability:</span>
                        <span class="summary-value" id="taxLiability">Rs. 0.00</span>
                    </div>
                    <div class="summary-item highlight">
                        <span class="summary-label">Net Profit After Tax:</span>
                        <span class="summary-value" id="netProfit">Rs. 0.00</span>
                    </div>
                </div>
            </section>

            <!-- What-If Analysis -->
            <section class="card">
                <h3>What-If Analysis</h3>
                <div class="whatif-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="whatifSymbol">Symbol</label>
                            <input type="text" id="whatifSymbol" placeholder="OGDC">
                        </div>
                        <div class="form-group">
                            <label for="whatifQuantity">Quantity</label>
                            <input type="number" id="whatifQuantity" min="1" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="whatifPrice">Sell Price</label>
                            <input type="number" id="whatifPrice" min="0" step="0.01" placeholder="150.00">
                        </div>
                        <div class="form-group">
                            <label for="whatifDate">Sell Date</label>
                            <input type="date" id="whatifDate">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="app.runWhatIfAnalysis()">Calculate</button>
                </div>
                <div id="whatifResults" class="whatif-results"></div>
            </section>

            <!-- Corporate Actions -->
            <section class="card">
                <h3>Corporate Actions</h3>
                <p style="color: #64748b; margin-bottom: 15px; font-size: 0.9rem;">
                    Apply bonus shares or right issues to adjust cost basis automatically
                </p>
                <form id="corporateActionForm" onsubmit="event.preventDefault(); handleCorporateActionSubmit();">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="caType">Action Type</label>
                            <select id="caType" required onchange="toggleRightIssueFields()">
                                <option value="BONUS">Bonus Shares</option>
                                <option value="RIGHT">Right Issue</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="caSymbol">Symbol</label>
                            <input type="text" id="caSymbol" placeholder="e.g., HBL" required>
                        </div>
                        <div class="form-group">
                            <label for="caRatio">Ratio</label>
                            <input type="text" id="caRatio" placeholder="20% or 1:5" required>
                        </div>
                        <div class="form-group" id="caPriceGroup" style="display: none;">
                            <label for="caPrice">Right Price</label>
                            <input type="number" id="caPrice" placeholder="80.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="caExDate">Ex-Date</label>
                            <input type="date" id="caExDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Apply Corporate Action</button>
                </form>
                <div id="corporateActionsHistory"></div>
            </section>

            <!-- Data Management -->
            <section class="card">
                <h3>Data Management</h3>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="app.saveData()">Save to Storage</button>
                    <button class="btn btn-secondary" onclick="app.loadData()">Load from Storage</button>
                    <button class="btn btn-secondary" onclick="app.clearAllData()">Clear All Data</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="app.importFromFile(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import JSON</button>
                </div>
                <div id="storageInfo" class="storage-info"></div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Pakistan Stock Tax Calculator | FIFO Method | Pakistan CGT Rules (15% flat rate for securities acquired after July 1, 2024)</p>
            <p class="disclaimer">This tool is for informational purposes only. Consult a tax professional for official tax advice.</p>
        </footer>
    </div>

    <!-- Message Toast -->
    <div id="messageToast" class="message-toast"></div>

    <!-- Load JavaScript Modules -->
    <script src="js/fifo-engine.js"></script>
    <script src="js/tax-calculator.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/what-if-scenarios.js"></script>
    <script src="js/pdf-generator.js"></script>
    <script src="js/corporate-actions.js"></script>
    <script src="js/app.js"></script>

    <!-- Corporate Actions UI Helper Script -->
    <script>
        // Toggle right issue price field
        function toggleRightIssueFields() {
            const type = document.getElementById('caType').value;
            const priceGroup = document.getElementById('caPriceGroup');
            const priceInput = document.getElementById('caPrice');

            if (type === 'RIGHT') {
                priceGroup.style.display = 'block';
                priceInput.required = true;
            } else {
                priceGroup.style.display = 'none';
                priceInput.required = false;
            }
        }

        // Handle corporate action form submission
        function handleCorporateActionSubmit() {
            const type = document.getElementById('caType').value;
            const symbol = document.getElementById('caSymbol').value.toUpperCase();
            const ratio = document.getElementById('caRatio').value;
            const exDate = document.getElementById('caExDate').value;
            const price = document.getElementById('caPrice').value;

            try {
                if (type === 'BONUS') {
                    app.applyBonusShares(symbol, ratio, exDate);
                } else if (type === 'RIGHT') {
                    if (!price) {
                        app.showMessage('Right issue price is required', 'error');
                        return;
                    }
                    app.applyRightIssue(symbol, ratio, parseFloat(price), exDate);
                }

                // Reset form
                document.getElementById('corporateActionForm').reset();
            } catch (error) {
                app.showMessage(`Error: ${error.message}`, 'error');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            toggleRightIssueFields();
        });
    </script>
</body>
</html>
